#'Hem Nalini Morzaria Luna
#'hmorzarialuna@gmail.com
#'July 2015
#'Extract INEGI population composition variables
#'for coastal communities in the Pacific


#'call needed packages
#install.packages= (c("sp","gdata","maptools","PBSmapping","rgdal","fields","raster",
#"rasterVis","dplyr","readxl","data.table","pipeR","tidyr","magrittr")) 
library(sp)
library(gdata)
library(maptools)
library(rgdal)
library(PBSmapping)
library(fields)
library(raster)
library(tidyr)
library(pipeR)
library(rasterVis)
library(readxl)
library(data.table)
library(magrittr)
library(dplyr)
library(rgeos)

####
#'clean up the space
rm(list=ls())

#'Initally extract total population from INEGI files
#'total population is needed from all 1990-2010
#'
#' USER BLOCK: CHECK AND CHANGE OPTIONS HERE  
#'_________________________________________________________________________
#'set working directories
#'this should match the path where your files directories are stored
#'note the "/" go in the opposite direction than in Windows explorer

#'All population composition variables are at the scale of locality
#'All data read in from INEGI files
#'
saveshapepath = "E:/Archivos/SIG/Proyectos/ArcGis/Datos ordenados/Shapes y layers/Archivos_articulos/Vulnerabilidad_pacifico"
shapepath = "F:/Archivos/SIG/Proyectos/ArcGis/Datos ordenados/Shapes y layers/CONABIO"

crs.lcc = CRS("+proj=lcc +lat_1=17.5 +lat_2=29.5 +lat_0=0 +lon_0=-102 +x_0=2000000 +y_0=0 +datum=NAD27 +units=m +no_defs")


setwd(shapepath)
mexico.shape <- readOGR(".", "contdv250kcw")#'this shapefile does not use wetlands, only marine areas
proj4string(mexico.shape)
mexico.shape.lcc = spTransform(mexico.shape, crs.lcc) 
# Read shapefile attributes



inegi.shape <- readOGR(".", "pobcloc10cw")
proj4string(inegi.shape)
inegi.shape.lcc = spTransform(inegi.shape, crs.lcc) 

inegi.50pop = inegi.shape[inegi.shape$POBTOT>49,]

mexico.10km <- gBuffer(mexico.shape.lcc, width=-10000) # remember units is m
proj4string(mexico.10km)
mexico.10km.lcc = spTransform(mexico.10km, crs.lcc) 

df = data.frame(1)
# subset ocurrence points within 10 km buffer
inegi.subset <- inegi.50pop[mexico.10km.lcc, ]

mexico.buffer = SpatialPolygonsDataFrame(mexico.10km.lcc,df)

writeOGR(inegi.50pop,saveshapepath,"inegi_50_pop","ESRI Shapefile")
writeOGR(mexico.10km.lcc,saveshapepath,"Mexico_10km_inerBuffer","ESRI Shapefile")
writeOGR(inegi.subset,saveshapepath,"inegi_50_pop_inBuffer","ESRI Shapefile")