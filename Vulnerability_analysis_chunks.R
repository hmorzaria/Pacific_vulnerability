#'Hem Nalini Morzaria Luna
#'hmorzarialuna@gmail.com
#'July 2015
#'Last edited Spet 2015
#'Extract coastal communities using DENUE data
#'for coastal communities in the Pacific


#'call needed packages
#' install.packages(c("sp","gdata","maptools","PBSmapping","rgdal","fields","raster",
#' "rasterVis","dplyr","readxl","data.table","pipeR","tidyr","magrittr")) 

## @knitr setpreferences

x = c("knitcitations","knitr","sp","gdata","maptools","PBSmapping",
      "rgdal","fields","raster","rgeos",
      "rasterVis","dplyr","data.table","pipeR","tidyr","magrittr") 

lapply(x, require, character.only = TRUE)

## @knitr transformshapefiles

####
#'clean up the space
rm(list=ls())

datapath="E:/Archivos/1Archivos/Articulos/En preparacion/Vulnerability_GOC_Pacific/Data" #'put path
analysispath="E:/Archivos/1Archivos/Articulos/En preparacion/Vulnerability_GOC_Pacific/Analysis" #'put path
shapepath = "E:/Archivos/SIG/Proyectos/ArcGis/Datos ordenados/Shapes y layers/Archivos_articulos/Vulnerabilidad_pacifico"
analysispath="E:/Archivos/1Archivos/Articulos/En preparacion/Vulnerability_GOC_Pacific/Analysis/ResultsINEGI" #'put path

#'_________________________________________________________________________

crs.geo.wgs <- CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")  # geographical, datum WGS84

#'set directory path for shapefiles
setwd(shapepath)

readOGR(".", "marine_area_250scale") %>% 
  spTransform(crs.geo.wgs) %>% 
writeOGR(".","Mexico_ezz",driver="ESRI Shapefile",overwrite_layer=TRUE)


#'read shapefile municipalities
readOGR(".", "mgm2013v6_2") %>% 
  spTransform(crs.geo.wgs) %>% 
writeOGR(".","municipalities_2014",driver="ESRI Shapefile",overwrite_layer=TRUE)


#'read shapefile communities
locations = readOGR(".", "mglr2013v6_2") %>% 
  spTransform(crs.geo.wgs)

  writeOGR(locations, ".","locations_2014",driver="ESRI Shapefile",overwrite_layer=TRUE)

  
  #'read shapefile communities
  urban.polygons = readOGR(".", "Localidades_urbanas_2013") %>% 
    spTransform(crs.geo.wgs)
  
  writeOGR(urban.polygons, ".","urban_locations_2014",driver="ESRI Shapefile",overwrite_layer=TRUE)
  

  #'read table CONAPESCA offices
  offices = fread("oficinas_pesca.txt",header=TRUE) %>% 
    data.frame
  
  coordinates(offices) <- c("LONG", "LAT")
  
  proj4string (offices) = (crs.geo.wgs)
  
  writeOGR(offices, ".","fishing_offices",driver="ESRI Shapefile",overwrite_layer=TRUE)
  
    
  #'read shapefile coastal municipalities
  #'this shapefile was geenrated in ArcGIS by selecting municipalities
  #'that intersect with mexico's EZZ using ArcMap
  #'select by location feature
  

  coastal.municipalities =  readOGR(".", "Coastal_municipalities")
  
# subset coastal locations
coastal.locations <- locations[coastal.municipalities, ]

writeOGR(coastal.locations, ".","coastal_locations_2014",driver="ESRI Shapefile",overwrite_layer=TRUE)

coastal.data = coastal.locations %>% 
  as("data.frame") %>% 
  tbl_df 

coastal.data2 = coastal.data %>% 
  mutate_each_(funs(as.numeric),"CVE_ENT") %>% 
  mutate_each_(funs(as.numeric),"CVE_MUN") %>% 
  mutate_each_(funs(as.numeric),"CVE_LOC") %>% 
  mutate(IDENTIFIER = paste(CVE_ENT,CVE_MUN,CVE_LOC,sep="_")) %>% 
  select(IDENTIFIER,coords.x1,coords.x2) %>% 
  data.frame
  
coastal.locations@data = coastal.data2

coastal.identifier = coastal.data2 %>% 
  tbl_df %>% 
  mutate_each_(funs(as.factor),"IDENTIFIER") %>% 
  group_by(IDENTIFIER) 


#'read shapefile DENUE database
denue.data = readOGR(".", "INEGI_DENUE_15092015")  %>% 
spTransform(crs.geo.wgs)

denue.urban <- denue.data[urban.polygons, ]

# subset coastal locations
denue.coast.urban <- denue.urban[coastal.municipalities, ]

denue.fisheries.urban = denue.coast.urban %>% 
  as("data.frame") %>% 
  tbl_df %>% 
  mutate_each_(funs(as.numeric),"cve_ent") %>% 
  mutate_each_(funs(as.numeric),"cve_mun") %>% 
  mutate_each_(funs(as.numeric),"cve_loc") %>% 
  unite(IDENTIFIER,cve_ent,cve_mun,cve_loc, sep = "_") %>% 
mutate(Index = 1) %>% 
  group_by(IDENTIFIER, coords.x1,coords.x2) %>% 
  summarise(counts = sum(Index)) %>% 
  mutate_each_(funs(as.character),"IDENTIFIER") %>% 
  select(IDENTIFIER, coords.x1,coords.x2) %>% 
setnames(c("IDENTIFIER","LONG","LAT")) %>% 
  data.frame
  
denue.fisheries = denue.data %>% 
  as("data.frame") %>% 
  tbl_df %>% 
  mutate_each_(funs(as.numeric),"cve_ent") %>% 
  mutate_each_(funs(as.numeric),"cve_mun") %>% 
  mutate_each_(funs(as.numeric),"cve_loc") %>% 
  unite(IDENTIFIER,cve_ent,cve_mun,cve_loc, sep = "_") %>% 
mutate(Index = 1) %>% 
  group_by(IDENTIFIER, coords.x1,coords.x2) %>% 
  summarise(counts = sum(Index)) %>% 
  mutate_each_(funs(as.character),"IDENTIFIER")


fishing.communities <- coastal.identifier  %>% 
  semi_join(denue.fisheries,by=c("IDENTIFIER")) %>% 
  ungroup %>% 
  select(IDENTIFIER,coords.x1,coords.x2) %>% 
  setnames(c("IDENTIFIER","LONG","LAT")) %>% 
  data.frame


#unite coastal office points (based on rural and urban locations)

office.1 = readOGR(".", "fishing_offices_att") %>% 
  as("data.frame") %>% 
  tbl_df %>% 
  mutate_each_(funs(as.numeric),"CVE_ENT") %>% 
  mutate_each_(funs(as.numeric),"CVE_MUN") %>% 
  mutate_each_(funs(as.numeric),"CVE_LOC") %>% 
  mutate(IDENTIFIER = paste(CVE_ENT,CVE_MUN,CVE_LOC,sep="_")) %>% 
  select(IDENTIFIER, coords.x1,coords.x2) %>% 
  setnames(c("IDENTIFIER","LONG","LAT")) %>% 
  data.frame
  

office.2 = readOGR(".", "fishing_offices_att_2") %>%
  as("data.frame") %>% 
  tbl_df %>% 
  mutate_each_(funs(as.numeric),"CVE_ENT") %>% 
  mutate_each_(funs(as.numeric),"CVE_MUN") %>% 
  mutate_each_(funs(as.numeric),"CVE_LOC") %>% 
  mutate(IDENTIFIER = paste(CVE_ENT,CVE_MUN,CVE_LOC,sep="_")) %>% 
  select(IDENTIFIER, coords.x1,coords.x2) %>% 
  setnames(c("IDENTIFIER","LONG","LAT")) %>% 
  data.frame
  
office.data = rbind(office.1, office.2)
office.data2 = office.data[!duplicated(office.data[,'IDENTIFIER']),]

coordinates(office.data2) <- c("LONG","LAT")
proj4string(office.data2) = crs.geo.wgs

# subset coastal offices
coastal.offices <- office.data2[coastal.municipalities, ]

coastal.offices.data = coastal.offices %>% 
  as("data.frame")


fishing.dependent = rbind(fishing.communities, denue.fisheries.urban,coastal.offices.data)

fishing.dependent2 = fishing.dependent[!duplicated(fishing.dependent[,'IDENTIFIER']),]

coordinates(fishing.dependent2) <- c("LONG", "LAT")

proj4string(fishing.dependent2) = crs.geo.wgs

setwd(shapepath)
writeOGR(fishing.dependent2, ".","fishing_dependent_communities",driver="ESRI Shapefile",overwrite_layer=TRUE)

#'read shapefile pacific states
Pacific.eds = readOGR(".", "estados_PacificoGC_WSG84") 


#'read shapefile GOM states
GOM.eds = readOGR(".", "estados_GMexico_WSG84")  

# subset coastal offices
fish.dep.pac <- fishing.dependent2[Pacific.eds, ]

# subset coastal offices
fish.dep.gom <- fishing.dependent2[GOM.eds, ]

writeOGR(fish.dep.pac, ".","fishing_dep_pac",driver="ESRI Shapefile",overwrite_layer=TRUE)

writeOGR(fish.dep.gom, ".","fishing_dep_gom",driver="ESRI Shapefile",overwrite_layer=TRUE)
