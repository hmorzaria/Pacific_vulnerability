#'Hem Nalini Morzaria Luna
#'hmorzraialuna@gmail.com
#'October 1, 2015
#'cleanup of data for vulnerability
#'
#'
x = c("readxl","knitcitations","knitr","xtable","devtools","gdata","maptools", 
"PBSmapping", "rgdal", "fields","data.table","raster", "rasterVis",
"sp","dplyr","SDMTools","ggplot2","ggmap", "httr","wesanderson","tidyr","cowplot")

lapply(x, require, character.only = TRUE)


## @knitr adultosmayores_PROGRESA_sedesol

rm(list=ls())    

datapath ="E:/Archivos/1Archivos/Articulos/En preparacion/Vulnerability_GOC_Pacific/Data/Datos_originales/adultosmayores_PROGRESA_sedesol"
setwd(datapath)
csv.files <- list.files(pattern = "\\.csv$")# list files

data.summary = as.data.frame(matrix(0,nrow=0,ncol=2))

for(eachfile in 1:length(csv.files)){
  
  
 this.file.data =csv.files[eachfile] %>% 
    fread(sep="^",skip = 2, na.strings ="") %>% 
   tbl_df %>% 
   mutate_each_(funs(as.numeric),"CVE_EDO") %>% 
   mutate_each_(funs(as.numeric),"CVE_MUN") %>% 
   mutate_each_(funs(as.numeric),"CVE_LOC") %>% 
   mutate(IDENTIFIER = paste(CVE_EDO,CVE_MUN,CVE_LOC,sep="_")) %>% 
   mutate(USER = 1) %>% 
   group_by(IDENTIFIER) %>% 
   summarise(usercount = sum(USER)) %>% 
   data.frame
   
  
data.summary = rbind(data.summary, this.file.data)
 
}

write.csv(data.summary,file="adultosmayores_PROGRESA_sedesol.csv")



## @knitr APOYOALIMENTARIO_sedesol

rm(list=ls())    

datapath ="E:/Archivos/1Archivos/Articulos/En preparacion/Vulnerability_GOC_Pacific/Data/Datos_originales/APOYOALIMENTARIO_sedesol"
setwd(datapath)
csv.files <- list.files(pattern = "\\.csv$")# list files

data.summary = as.data.frame(matrix(0,nrow=0,ncol=7))

for(eachfile in 1:length(csv.files)){
  
  
  this.file.data =csv.files[eachfile] %>% 
    fread(sep="^",skip = 4, na.strings ="") %>% 
    tbl_df %>% 
    mutate_each_(funs(as.numeric),"CVE_EDO") %>% 
    mutate_each_(funs(as.numeric),"CVE_MUN") %>% 
    mutate(IDENTIFIER = paste(CVE_EDO,CVE_MUN,sep="_")) %>% 
    select(c(11,5:10)) %>% 
    setnames(c("IDENTIFIER", "Fam_Sedesol","Inf_Sedesol","Alim_Sedesol","Apo_Inf_Sedesol","Ali_Com_Sedesol","Total_Sedesol")) %>% 
    data.frame
  
  
  data.summary = rbind(data.summary, this.file.data)
  
}

write.csv(data.summary,file="APOYOALIMENTARIO_sedesol.csv")


## @knitr apoyosmonetarios_PROGRESA_sedesol

rm(list=ls())    

datapath ="E:/Archivos/1Archivos/Articulos/En preparacion/Vulnerability_GOC_Pacific/Data/Datos_originales/apoyosmonetarios_PROGRESA_sedesol"
setwd(datapath)
csv.files <- list.files(pattern = "\\.csv$")# list files

data.summary = as.data.frame(matrix(0,nrow=0,ncol=12))

for(eachfile in 1:length(csv.files)){
  
  
  this.file.data =csv.files[eachfile] %>% 
    fread(sep="^",skip = 2, na.strings ="") %>% 
    tbl_df %>% 
    mutate_each_(funs(as.numeric),"CVE_EDO") %>% 
    mutate_each_(funs(as.numeric),"CVE_MUN") %>% 
    mutate(IDENTIFIER = paste(CVE_EDO,CVE_MUN,sep="_")) %>% 
    select(c(17,5:14,16)) %>% 
    setnames(c("IDENTIFIER", "Fam_Progresa","Bec_Progresa","Inf_Progresa","Adu_Progresa","Alim_Progresa",
               "AduMa_Progresa","Edu_Progresa","Apo_Inf_Progresa","Ali_Com_Progresa","Edhuca","Tot_Progresa")) %>% 
    data.frame
  
  data.summary = rbind(data.summary, this.file.data)
  
}

write.csv(data.summary,file="apoyosmonetarios_PROGRESA_sedesol.csv")


## @knitr becarios_PROGRESA_sedesol


rm(list=ls())    

datapath ="E:/Archivos/1Archivos/Articulos/En preparacion/Vulnerability_GOC_Pacific/Data/Datos_originales/becarios_PROGRESA_sedesol"
setwd(datapath)
csv.files <- list.files(pattern = "\\.csv$")# list files

data.summary = as.data.frame(matrix(0,nrow=0,ncol=2))

for(eachfile in 1:length(csv.files)){
  
  
  this.file.data =csv.files[eachfile] %>% 
    fread(sep="^",skip = 2, na.strings ="") %>% 
    tbl_df %>% 
    mutate_each_(funs(as.numeric),"CVE_EDO") %>% 
    mutate_each_(funs(as.numeric),"CVE_MUN") %>% 
    mutate_each_(funs(as.numeric),"CVE_LOC") %>% 
    mutate(IDENTIFIER = paste(CVE_EDO,CVE_MUN,CVE_LOC,sep="_")) %>% 
    mutate(USER = 1) %>% 
    group_by(IDENTIFIER) %>% 
    summarise(count_becarios = sum(USER)) %>% 
    data.frame
  
  data.summary = rbind(data.summary, this.file.data)
  
}

write.csv(data.summary,file="becarios_PROGRESA_sedesol.csv")



## @knitr FAMILIA_pal_sedesol


rm(list=ls())    

datapath ="E:/Archivos/1Archivos/Articulos/En preparacion/Vulnerability_GOC_Pacific/Data/Datos_originales/FAMILIA_pal_sedesol"
setwd(datapath)
csv.files <- list.files(pattern = "\\.csv$")# list files

data.summary = as.data.frame(matrix(0,nrow=0,ncol=4))

for(eachfile in 1:length(csv.files)){
  
  
  
  this.file.data =csv.files[eachfile] %>% 
    fread(sep="^",skip = 3, na.strings ="") %>% 
    tbl_df %>% 
    mutate_each_(funs(as.numeric),"CVE_EDO") %>% 
    mutate_each_(funs(as.numeric),"CVE_MUN") %>% 
    mutate_each_(funs(as.numeric),"CVE_LOC") %>% 
    mutate(IDENTIFIER = paste(CVE_EDO,CVE_MUN,CVE_LOC,sep="_")) %>% 
    select(c(15,10:12)) %>% 
    setnames(c("IDENTIFIER","Ali_Pal","Ali_Co_Pal","Inf_Pal")) %>% 
    mutate(user = 1) %>% 
    group_by(IDENTIFIER) %>% 
    summarise(sum_Ali_Pal = sum(Ali_Pal), sum_Ali_Co_Pal = sum(Ali_Co_Pal),sum_Inf_Pal = sum(Inf_Pal),user_Pal = sum(user)) %>% 
    data.frame
  
  data.summary = rbind(data.summary, this.file.data)
  data.summary = rbind(data.summary, this.file.data)
  
}

write.csv(data.summary,file="FAMILIA_pal_sedesol.csv")

## @knitr familias_PROGRESA_sedesol


rm(list=ls())    

datapath ="E:/Archivos/1Archivos/Articulos/En preparacion/Vulnerability_GOC_Pacific/Data/Datos_originales/familias_PROGRESA_sedesol"
setwd(datapath)
csv.files <- list.files(pattern = "\\.csv$")# list files

data.summary = as.data.frame(matrix(0,nrow=0,ncol=6))

for(eachfile in 1:length(csv.files)){
  
  
  this.file.data =csv.files[eachfile] %>% 
    fread(sep="^",skip = 2, na.strings ="",header=FALSE) %>% 
    tbl_df %>% 
    mutate_each_(funs(as.numeric),"CVE_EDO") %>% 
    mutate_each_(funs(as.numeric),"CVE_MUN") %>% 
    mutate_each_(funs(as.numeric),"CVE_LOC") %>% 
    mutate(IDENTIFIER = paste(CVE_EDO,CVE_MUN,CVE_LOC,sep="_")) %>% 
    select(c(19,10:14)) %>% 
    setnames(c("IDENTIFIER","Ali_Progresa","Edu_Progresa","AduMa_Progresa","Ali_Co_Progresa","Inf_Progresa")) %>% 
    mutate(user = 1) %>% 
    group_by(IDENTIFIER) %>% 
    summarise(sum_Ali_Progresa = sum(Ali_Progresa), sum_Edu_Progresa = sum(Edu_Progresa),sum_AduMa_Progresa = sum(AduMa_Progresa),
              sum_Ali_Co_Progresa = sum(Ali_Co_Progresa),sum_Inf_Progresa = sum(Inf_Progresa),user_Progresa = sum(user)) %>% 
    data.frame
  
  data.summary = rbind(data.summary, this.file.data)
  
}

write.csv(data.summary,file="familias_PROGRESA_sedesol.csv")

## @knitr INFANTIL_pal_sedesol

rm(list=ls())    

datapath ="E:/Archivos/1Archivos/Articulos/En preparacion/Vulnerability_GOC_Pacific/Data/Datos_originales/INFANTIL_pal_sedesol"
setwd(datapath)
csv.files <- list.files(pattern = "\\.csv$")# list files

data.summary = as.data.frame(matrix(0,nrow=0,ncol=2))

for(eachfile in 1:length(csv.files)){
  
  
  this.file.data =csv.files[eachfile] %>% 
    fread(sep="^",skip = 4, na.strings ="") %>% 
    tbl_df %>% 
    mutate_each_(funs(as.numeric),"CVE_EDO") %>% 
    mutate_each_(funs(as.numeric),"CVE_MUN") %>% 
    mutate_each_(funs(as.numeric),"CVE_LOC") %>% 
    mutate(IDENTIFIER = paste(CVE_EDO,CVE_MUN,CVE_LOC,sep="_")) %>% 
    mutate(USER = 1) %>% 
    group_by(IDENTIFIER) %>% 
    summarise(count_Inf_Pal = sum(USER)) %>% 
    data.frame
  
  
  data.summary = rbind(data.summary, this.file.data)
  
}

write.csv(data.summary,file="INFANTIL_pal_sedesol.csv")



## @knitr infantil_PROGRESA_sedesol

rm(list=ls())    

datapath ="E:/Archivos/1Archivos/Articulos/En preparacion/Vulnerability_GOC_Pacific/Data/Datos_originales/infantil_PROGRESA_sedesol"
setwd(datapath)
csv.files <- list.files(pattern = "\\.csv$")# list files

data.summary = as.data.frame(matrix(0,nrow=0,ncol=2))

for(eachfile in 1:length(csv.files)){
  
  
  this.file.data =csv.files[eachfile] %>% 
    fread(sep="^",skip = 2, na.strings ="") %>% 
    tbl_df %>% 
    mutate_each_(funs(as.numeric),"CVE_EDO") %>% 
    mutate_each_(funs(as.numeric),"CVE_MUN") %>% 
    mutate_each_(funs(as.numeric),"CVE_LOC") %>% 
    mutate(IDENTIFIER = paste(CVE_EDO,CVE_MUN,CVE_LOC,sep="_")) %>% 
    mutate(USER = 1) %>% 
    group_by(IDENTIFIER) %>% 
    summarise(count_Inf_Progresa = sum(USER)) %>% 
    data.frame
  
  
  data.summary = rbind(data.summary, this.file.data)
  
}

write.csv(data.summary,file="infantil_PROGRESA_sedesol.csv")

## @knitr APOYOMONETARIO_sedesol

rm(list=ls())    

datapath ="E:/Archivos/1Archivos/Articulos/En preparacion/Vulnerability_GOC_Pacific/Data/Datos_originales/APOYOMONETARIO_sedesol"
setwd(datapath)
csv.files <- list.files(pattern = "\\.csv$")# list files

data.summary = as.data.frame(matrix(0,nrow=0,ncol=7))

for(eachfile in 1:length(csv.files)){
  
  
  this.file.data =csv.files[eachfile] %>% 
    fread(sep="^",skip = 4, na.strings ="") %>% 
    tbl_df %>% 
    mutate_each_(funs(as.numeric),"CVE_EDO") %>% 
    mutate_each_(funs(as.numeric),"CVE_MUN") %>% 
    mutate(IDENTIFIER = paste(CVE_EDO,CVE_MUN,sep="_")) %>% 
    select(c(11,5:10)) %>% 
    setnames(c("IDENTIFIER", "Fam_Pal","Inf_Pal","Alim_Pal",
               "Apo_Inf_Pal","Ali_Com_Pal","Tot_Pal")) %>% 
    data.frame
  
  data.summary = rbind(data.summary, this.file.data)
  
}

write.csv(data.summary,file="APOYOMONETARIO_sedesol.csv")


## @knitr caracteristicas economicas

rm(list=ls())    

datapath ="E:/Archivos/1Archivos/Articulos/En preparacion/Vulnerability_GOC_Pacific/Data/Datos_organizados"
setwd(datapath)

all.files <- list.files()# list files
write.csv(all.files,file="file_list.csv")

data.summary = as.data.frame(matrix(0,nrow=0,ncol=11))

xls.files <- list.files(pattern = "caracteristicas_economicas")# list files

for(eachfile in 1:length(xls.files))
  
{

print(paste("Analyzing"," file",eachfile,"_",xls.files[eachfile]))

  file.name = xls.files[eachfile] %>% 
    strsplit("[.]") %>% 
    unlist %>% 
    .[1]
    
this.data =   xls.files[eachfile] %>% 
    read_excel(sheet = 1, col_names = TRUE, col_types = NULL, na = c(""),skip = 0) 

data.names = c("Entidad","Municipio","Estimador",
"Poblacion_ocupada", "IngT_1sm","IngT_1a2sm","IngT_2sm","IngT_NE")

rev.data =  this.data %>% 
    sapply(gsub,pattern="ND",replacement="NA") %>% 
    as.data.frame %>% 
    setnames(data.names) %>% 
     tbl_df %>% 
  filter(Municipio!="Total") %>% 
  filter(Estimador=="Parametro") %>% 
  separate(Entidad, c("CVE_ENT", "EDO"), 2) %>% 
  separate(Municipio, c("CVE_MUN", "MUN"), 3) %>% 
  mutate_each_(funs(as.numeric),"CVE_ENT") %>% 
  mutate_each_(funs(as.numeric),"CVE_MUN") %>% 
  mutate(IDENTIFIER = paste(CVE_ENT,CVE_MUN,sep="_")) %>% 
  select(IDENTIFIER,1:10)
  

data.summary = rbind(data.summary, rev.data)
  
}

write.csv(data.summary,paste("caracteristicas_economicas.csv",sep=""))


## @knitr duplicates xls

rm(list=ls())    

datapath ="E:/Archivos/1Archivos/Articulos/En preparacion/Vulnerability_GOC_Pacific/Data/Datos_organizados"
setwd(datapath)

data.summary = as.data.frame(matrix(0,nrow=0,ncol=5))

xls.files <- list.files(pattern = "\\.xls*$")# list files

for(eachfile in 1:length(xls.files))
  
{
  
  print(paste("Analyzing"," file",eachfile,"_",xls.files[eachfile]))
  
  file.name = xls.files[eachfile] %>% 
    strsplit("[.]") %>% 
    unlist %>% 
    .[1] %>% 
    data.frame %>% 
    setnames("file_name")
  
  this.data =   xls.files[eachfile] %>% 
    read_excel(sheet = 1, col_names = TRUE, col_types = NULL, na = c(""),skip = 0) 
  
  names.data = names(this.data)
  
  duplicates.names = duplicated(names.data)
  
  clave = match('Clave',names.data)
  clave_ent = match('CVE_ENT',names.data)
  clave_loc = match('CVE_LOC',names.data)
  identifier = match('IDENTIFIER',names.data)
  
  
  num_duplicates = length(duplicates.names[duplicates.names==TRUE]>0)
  
  file.name = file.name %>% 
    mutate(num_duplicates = num_duplicates) %>% 
    mutate(clave = clave) %>% 
    mutate(clave_ent = clave_ent) %>% 
    mutate(clave_loc = clave_loc) %>% 
    mutate(identifier = identifier)
  
  data.summary = rbind (data.summary, file.name)
}

write.csv(data.summary,file="duplicate_files_xls.csv")


## @knitr duplicates csv

rm(list=ls())    

datapath ="E:/Archivos/1Archivos/Articulos/En preparacion/Vulnerability_GOC_Pacific/Data/Datos_organizados"
setwd(datapath)

data.summary = as.data.frame(matrix(0,nrow=0,ncol=6))

csv.files <- list.files(pattern = "\\.csv*$")# list files

for(eachfile in 1:length(csv.files))
  
{
  
  print(paste("Analyzing"," file",eachfile,"_",csv.files[eachfile]))
  
  file.name = csv.files[eachfile] %>% 
    strsplit("[.]") %>% 
    unlist %>% 
    .[1] %>% 
    data.frame %>% 
    setnames("file_name")
  
  this.data =  csv.files[eachfile] %>% 
    fread(header=T, sep=",")
  
  names.data = names(this.data)
  
  duplicates.names = duplicated(names.data)
  
  clave = match('Clave',names.data)
  clave_ent = match('CVE_ENT',names.data)
  clave_loc = match('CVE_LOC',names.data)
  identifier = match('IDENTIFIER',names.data)
  
  
  num_duplicates = length(duplicates.names[duplicates.names==TRUE]>0)
  
  file.name = file.name %>% 
    mutate(num_duplicates = num_duplicates) %>% 
    mutate(clave = clave) %>% 
    mutate(clave_ent = clave_ent) %>% 
    mutate(clave_loc = clave_loc) %>% 
    mutate(identifier = identifier)
  
  data.summary = rbind (data.summary, file.name)
}

write.csv(data.summary,file="duplicate_files_csv.csv")




## @knitr duplicates xls

rm(list=ls())    

datapath ="E:/Archivos/1Archivos/Articulos/En preparacion/Vulnerability_GOC_Pacific/Data/Datos_organizados"
setwd(datapath)

data.summary = as.data.frame(matrix(0,nrow=0,ncol=5))

xls.files <- list.files(pattern = "\\.xlsx$")# list files

for(eachfile in 1:length(xls.files))
  
{
  
  print(paste("Analyzing"," file",eachfile,"_",xls.files[eachfile]))
  
  file.name = xls.files[eachfile] %>% 
    strsplit("[.]") %>% 
    unlist %>% 
    .[1] %>% 
    data.frame %>% 
    setnames("file_name")
  
  this.data =   xls.files[eachfile] %>% 
    read_excel(sheet = 1, col_names = TRUE, col_types = NULL, na = c(""),skip = 0) 
  
  names.data = names(this.data)
  
  duplicates.names = duplicated(names.data)
  
  clave = match('Clave',names.data)
  clave_ent = match('CVE_ENT',names.data)
  clave_loc = match('CVE_LOC',names.data)
  identifier = match('IDENTIFIER',names.data)
  
  
  num_duplicates = length(duplicates.names[duplicates.names==TRUE]>0)
  
  file.name = file.name %>% 
    mutate(num_duplicates = num_duplicates) %>% 
    mutate(clave = clave) %>% 
    mutate(clave_ent = clave_ent) %>% 
    mutate(clave_loc = clave_loc) %>% 
    mutate(identifier = identifier)
  
  data.summary = rbind (data.summary, file.name)
}

write.csv(data.summary,file="duplicate_files_xlsx.csv")

  