#'Hem Nalini Morzaria Luna
#'hmorzarialuna@gmail.com
#'July 2015
#'Last edited Spet 2015
#'Extract coastal communities using DENUE data
#'for coastal communities in the Pacific


#'call needed packages
#' install.packages(c("sp","gdata","maptools","PBSmapping","rgdal","fields","raster",
#' "rasterVis","dplyr","readxl","data.table","pipeR","tidyr","magrittr")) 

x = c("sp","gdata","maptools","PBSmapping","rgdal","fields","raster",
"rasterVis","dplyr","readxl","data.table","pipeR","tidyr","magrittr") 

lapply(x, require, character.only = TRUE)


####
#'clean up the space
rm(list=ls())

#'Initally extract total population from INEGI files
#'total population is needed from all 1990-2010
#'
#' USER BLOCK: CHECK AND CHANGE OPTIONS HERE  
#'_________________________________________________________________________
#'set working directories
#'this should match the path where your files directories are stored
#'note the "/" go in the opposite direction than in Windows explorer

datapath="E:/Archivos/1Archivos/Articulos/En preparacion/Vulnerability_GOC_Pacific/Data" #'put path
analysispath="E:/Archivos/1Archivos/Articulos/En preparacion/Vulnerability_GOC_Pacific/Analysis" #'put path
shapepath = "E:/Archivos/SIG/Proyectos/ArcGis/Datos ordenados/Shapes y layers/Archivos_articulos/Vulnerabilidad_pacifico"
analysispath="E:/Archivos/1Archivos/Articulos/En preparacion/Vulnerability_GOC_Pacific/Analysis/ResultsINEGI" #'put path

#'_________________________________________________________________________

#'set directory path for shapefiles
setwd(shapepath)


#'read shapefile coastal locations >50 habitats
denue.agriculture <- readOGR(".", "Inegi_DENUE_30012015") %>% 
  as("data.frame") %>% 
  tbl_df 


comunidades <- readOGR(".", "comunidades_pacifico")

crs.coastal <- readOGR(".", "comunidades_pacifico") %>% proj4string

comunidades.identifier <- readOGR(".", "comunidades_pacifico") %>% 
  as("data.frame") %>% 
  tbl_df %>% 
  mutate_each_(funs(as.character),"IDENTIFIER") %>% 
  dplyr::select(IDENTIFIER) 


categories.denue <- unique(denue.agriculture$nom_estab)

denue.fisheries <- denue.agriculture %>%
  dplyr::filter (grepl('PISC?COLA|OCEAN|SEED|AQUAPACIFIC|BAHIA|
                ROBALEROS|MOJARRA|TILAPIA|TRUCHAS|PULPEROS|
                ANZUELEROS|OSTRICOLA|CAMARON|TORTUGA|CHARAL|
                LANGOSTA|LAGUNA|OSTION|CANGREJ|
                MAR|MARINOS|MARINAS|NAVEGANTES|MARISCO|MARICU
                ACUACULTORES|ACU?COLA|ACUICULTORES|ACUACULTIVOS|ACUACULTURA|ACUA|
                PESCADO|PESCADOS|PECES|PESC.|PESQUERAS|PESQUERA|PESCA|PESCADORES|PESCADOR|
                PESQ|PESQUERIAS|PISCICOLA|ACUIPESCA|PESQ|
                BARCO|PANGA|PALANGRE|
                MANGLAR|MARISMAS|
                SCPP|SCPPC|S.C.P.P|SPP|UPP ', nom_estab)) 

denue.fisheries$Index = 1

 inegi.coastal <- denue.fisheries %>% 
    mutate_each_(funs(as.numeric),"cve_ent") %>% 
    mutate_each_(funs(as.numeric),"cve_mun") %>% 
  mutate_each_(funs(as.numeric),"cve_loc") %>% 
 unite(IDENTIFIER,cve_ent,cve_mun,cve_loc, sep = "_") %>% 
   mutate_each_(funs(as.factor),"IDENTIFIER") %>% 
   group_by(IDENTIFIER) %>% 
   summarise(counts = sum(Index)) %>% 
 mutate_each_(funs(as.character),"IDENTIFIER")
 
  comunidades.identifier <- comunidades.identifier  %>% 
  left_join(inegi.coastal,by=c("IDENTIFIER")) 
 
  comunidades.identifier2 = comunidades.identifier[complete.cases(comunidades.identifier),]  #eliminate rows with NA
  
  comunidades@data = data.frame(comunidades@data, comunidades.identifier[match(comunidades@data$IDENTIFIER, comunidades.identifier$IDENTIFIER),])
  
  
  submet = subset(comunidades, counts>0)
  
  setwd(shapepath)
  writeOGR(comunidades, ".","Pacific_fishing_communities",driver="ESRI Shapefile",overwrite_layer=TRUE)
  