#Hem Nalini Morzaria Luna
#hmorzarialuna@gmail.com
#Julio 2015
#Codigo para extraer datos de localidades costeras
#localizadas a 50 km de la costa
#variables socioeconomicas

#instalar bibliotecas
#use these lines if packages are not installed
#install.packages("sp","gdata","XLConnect","maptools",PBSmapping","rgdal","fields","raster","rasterVis")
#install.packages("spstat")
library(gdata)
library(maptools)   # used here to read in the spatial data
library(PBSmapping) # for GIS-like geoprocessing operations
library(rgdal)  
library(fields)
library(spocc)
library(rgbif)
library(raster)
library(rasterVis)
library(sp)
library(sperich)
library(dplyr)
library(readxl)

#clean up the space

rm(list=ls())



# USER BLOCK: CHECK AND CHANGE OPTIONS HERE  
#_________________________________________________________________________
#set working directories
#this should match the path where your files directories are stored
#note the "/" go in the opposite direction than in Windows explorer

datapath="E:/Archivos/1Archivos/Articulos/En preparacion/Vulnerability_GOC_Pacific/Data" #put path
analysispath="E:/Archivos/1Archivos/Articulos/En preparacion/Vulnerability_GOC_Pacific/Analysis" #put path
savepath = "E:/Archivos/SIG/Proyectos/ArcGis/Datos ordenados/Shapes y layers/Archivos_articulos/Vulnerabilidad_pacifico"

foldersinegi=c("INEGI_Conteo_2005","INEGI_Censo_2010","INEGI_Censo_1990","INEGI_Censo_2000")
folderssedesol=c("becarios_PROGRESA_sedesol","APOYOMONETARIO_sedesol")

#set directory path
setwd(savepath)

#read in Gulf of California shapefile
goc.shape <- readOGR(".", "Golfo_california_polygon_WSG84")#this shapefile does not use wetlands, only marine areas
# Leer shapefile de localidades, debe tener nombre de localidad, municipio y estado
#shapefile de localidades costeras para el Golfo y Pacifico
pacific.coastal.shape <- readOGR(".", "pacifico_mas50hab_WSG84_data")
coastal.shp <- as(pacific.coastal.shape, "data.frame")

lista.categorias = c("Composición de la población","Vivienda", "Ingreso","Pobreza","Salud","Seguridad","Pesca","Empleo","Medio ambiente","Características de genero")

#leer archivos INEGI

# for excel files from UABCS
setwd(datapath)


for(each.folder in 1:length(foldersinegi))
  
{
  this.folder = foldersinegi[each.folder]
  folderpath = paste(datapath,"/",this.folder,sep="")
  setwd(folderpath)
  xls.files <- list.files(pattern = "\\.xls$")# list files

  census = as.data.frame(matrix(0,nrow=0,ncol=0))
  
#loop to read in data and obtain GOC data
for(each.file in 1:length(xls.files))
{
  
  this.file = xls.files[each.file]#select file
  print(paste("Analyzing"," file",each.file,"_",this.file))
  df = read_excel(this.file, sheet = 1, col_names = TRUE, col_types = NULL, na = "",skip = 0)
  census = rbind(census,df)
}
  setwd(datapath)
  write.csv(census,file=paste(this.folder,".csv",sep=""))
}
  
# Leer lista de categorias y variables por categoria
# Leer tabla variables
# Leer inventario archivos
# Extraer lista de variables para esa categoria
# Para cada tipo de archivos (*.csv, *.xls,*.shp)
# Buscar en el inventario de archivos el numero de fila en que empiezan los datos
# leer el archivo
# reemplazar NA valores vacios
# extraer el nombre del archivo
# sacar del inventario de datos las variables que corresponden a ese archivo
# determinar la escala de datos (localidad, municipio, estado) para la variable
# Para cada variable
# asignar valores de la variable a la tabla usando la escala correspondiente
# agregar nombre de la columna, que debe ser el mismo que la variable
# 
# Repetir con todas las categorias
# 
# Para los archivos en subdirectorios
# listar folders
# en inventario folders ve rla escala de datos (municipio, edo)
# extraer archivops que correspondan a las escalas
# del inventario de datos sacar las variables que corresponden al archivo
# asignar valores de variable a la tabla
# nombre de la columna debe ser el mismo de la variable