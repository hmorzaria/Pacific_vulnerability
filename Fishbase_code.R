#'Hem Nalini Morzaria Luna
#'hmorzarialuna@gmail.com
#'Based on R script by Miguel Gandra || m3gandra@gmail.com || April 2015 
#' 
#'clean up the space
rm(list=ls())

#' Automatically install required libraries  

if(!require(dismo)){install.packages("dismo"); library(dismo)}
if(!require(XML)){install.packages("XML"); library(XML)}
if(!require(jsonlite)){install.packages("jsonlite"); library(jsonlite)}
if(!require(graphics)){install.packages("graphics"); library(graphics)}
if(!require(maps)){install.packages("maps"); library(maps)}
if(!require(maptools)){install.packages("maptools"); library(maptools)}
if(!require(rgeos)){install.packages("rgeos"); library(rgeos)}
if(!require(rgdal)){install.packages("rgdal"); library(rgdal)}
if(!require(magrittr)){install.packages("magrittr"); library(magrittr)}
if(!require(dplyr)){install.packages("dplyr"); library(dplyr)}
if(!require(Hmisc)){install.packages("Hmisc"); library(Hmisc)}

workpath = "E:/Archivos/1Archivos/Articulos/En preparacion/Vulnerability_GOC_Pacific/Analysis/RCode"
#' Variables 
genus <- "Sphyrna"
species <- "lewini"

setwd(workpath)
# Get records from FishBase ###########################################################

url <- paste("http://www.fishbase.org/Map/OccurrenceMapList.php?genus=",
             genus,"&species=",species,"&dsource=darwin_all_v2",sep="")

fishbase.data <- try(readHTMLTable(url),silent=FALSE)
if(class(fishbase.data)=="try-error"){
  fishbase.coordinates<-data.frame(matrix(ncol=2, nrow=0))
  stop("FishBase data download failed")
}else{
  
  n.rows = fishbase.data %>% lapply(function(t) dim(t) [1]) %>% unlist %>% 
    which.max
  
  fishbase.data.1 <- fishbase.data[[n.rows]]
  
  #' define a helper function to replace empty values
  empty_as_na <- function(x) ifelse(x=="", NA, x)
  
  fishbase.coordinates <- data.frame(fishbase.data.1[,3],fishbase.data.1[,4])
  fishbase.data.2 = fishbase.coordinates %>% mutate_each(funs(empty_as_na)) %>% 
    na.omit %>% tbl_df %>% 
    mutate(Species = paste(genus,species,sep=" ")) %>% 
    setNames(c("Lat","Long","Species")) %>% select(Species,Lat,Long)
    
  fishbase.data.3 = fishbase.data.2[2:nrow(fishbase.data.2),]
  
}

write.csv(fishbase.data.3,file=paste(genus,species,".csv",sep="_"))

#' retrieve all records for an ecosystem
#' Gulf of California = 165
#' 
site = 165 # 144 Gulf of Mexico, 132 California Current, 145 Caribbean

url <- paste("http://www.fishbase.org/map/EcosystemOccurrencesList.php?e_code=",
             site,sep="")

fishbase.data <- try(readHTMLTable(url),silent=TRUE)

fishbase.data.1 = fishbase.data[[3]] %>% data.frame
fishbase.coordinates <- data.frame(fishbase.data.1[,2], fishbase.data.1[,5],fishbase.data.1[,6])

#' define a helper function to replace empty values
empty_as_na <- function(x) ifelse(x=="", NA, x)

fishbase.coordinates.1 = fishbase.coordinates %>% setNames(c("Species","Lat","Long")) %>% 
  mutate(Lat=as.character(Lat)) %>%  mutate(Lat=as.numeric(Lat)) %>% 
  mutate(Long=as.character(Long)) %>%  mutate(Long=as.numeric(Long)) %>% 
  tbl_df %>% mutate_each(funs(empty_as_na)) %>% na.omit

