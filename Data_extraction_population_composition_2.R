#'Hem Nalini Morzaria Luna
#'hmorzarialuna@gmail.com
#'July 2015
#'Extract INEGI population composition variables
#'for coastal communities in the Pacific


#'call needed packages
#' install.packages(c("sp","gdata","maptools","PBSmapping","rgdal","fields","raster",
#' "rasterVis","dplyr","readxl","data.table","pipeR","tidyr","magrittr")) 
library(sp)
library(gdata)
library(maptools)
library(rgdal)
library(PBSmapping)
library(fields)
library(raster)
library(tidyr)
library(pipeR)
library(rasterVis)
library(readxl)
library(data.table)
library(magrittr)
library(dplyr)

####
#'clean up the space
rm(list=ls())

#'Initally extract total population from INEGI files
#'total population is needed from all 1990-2010
#'
#' USER BLOCK: CHECK AND CHANGE OPTIONS HERE  
#'_________________________________________________________________________
#'set working directories
#'this should match the path where your files directories are stored
#'note the "/" go in the opposite direction than in Windows explorer

#'All population composition variables are at the scale of locality
#'All data read in from INEGI files
#'
datapath="E:/Archivos/1Archivos/Articulos/En preparacion/Vulnerability_GOC_Pacific/Data" #'put path
analysispath="E:/Archivos/1Archivos/Articulos/En preparacion/Vulnerability_GOC_Pacific/Analysis" #'put path
shapepath = "E:/Archivos/SIG/Proyectos/ArcGis/Datos ordenados/Shapes y layers/Archivos_articulos/Vulnerabilidad_pacifico"
analysispath="E:/Archivos/1Archivos/Articulos/En preparacion/Vulnerability_GOC_Pacific/Analysis/ResultsINEGI" #'put path

#'folders storing xls files from each census
foldersinegi=c("INEGI_Conteo_2005","INEGI_Censo_2010","INEGI_Censo_1990","INEGI_Censo_2000")

#'coding variables in INEGI files 
inegi.coding = c("ENTIDAD","MUN","LOC")
coastal.coding = c("CVE_EDO","CVE_MUN","CVE_LOC")

index.name = "PopulationComposition"

#'colnames for 1990 files
inegi.1990.names = c("ENTIDAD","NOM_ENT","MUN","NOM_MUN","LOC","NOM_LOC","LONGITUD","LATITUD",
										 "ALTITUD","P_TOTAL","HOMBRES","MUJERES","POB_LEE","POB_NO_L","ALFABET","ANALFBET",
										 "ASIS_ESC","N_AS_ESC","ASIS6_ES","N_AS6_ES","N_HAB_ESP","HABLA_ESP","SIN_INS","PRIM_INC",
										 "PRIM_COM","INS_PPRIM","P_E_ACT","P_E_INAC","POB_OCUP","SEC_PRIM","SEC_SEC","SEC_TER",
										 "T_VIVHAB","VIV_PART","OCUP_VIV","PROM_VIV","PROM_CUA","PARED_LA","TECHO_LA","PISO_TIE",
										 "VIV_1_C","VIV_2_C","C_AGUA_ENT","C_DRENAJE","C_E_ELECT","VIV_PPROP")
#' colnames for 2000 files
inegi.2000.names = c("ENTIDAD","NOM_ENT","MUN","NOM_MUN","LOC","NOM_LOC","LONGITUD","LATITUD",
										 "ALTITUD","POBTOT","PMASCUL","PFEMENI","POB0_4","P5_MAS","POB6_14","POB12_",
										 "POB15_","POB15_17","POB15_24","POBF15_49","POB18_","PMASC18_","PFEMEN18_","PSDERSS",
										 "PCDERSS","PDERIMSS","PDERISTE","PNACENT","PNACOENT","P5_RES95","P5_RESO95","PCONDISC",
										 "PCDISMOT","PCDISAUD","PCDISVIS","PCDISMEN","PCDISLEN","PSINDISC","P6_14SLEE","P6_14NLEE",
										 "P15_ALFAB","P15_ANALF","P5_ASIESC","P5_NAESC","P6_14AESC","P6_14NAESC","P15_17AESC","P15_24AESC",
										 "P15_24NESC","P15_SINSTR","P15_SPRIMA","P15_CPRIMA","P15_POSPRI","P15_SSECU","P15_CSECU","P15_SINSEC",
										 "P15_CONSEC","P15_CMEDSS","P18_SMEDSU","P18_CMEDSU","P18_CSUPER","GRADOESCO","PSOLTER12_","PCASADA12_",
										 "P5_HLI","P5_HLIYNE","P5_HLIYE","P5_CATOLIC","P5_NCATOLI","P5_SINRELI","PECOACTIV","PECOINACT",
										 "POCUPADA","POCUSECP","POCUSECS","POCUSECT","POCUNINGR","P_1SM","P1_2SM","P2_5SM",
										 "P6_10SM","P10_SM","PNOTRABA","P_32HTRA","P33_40HTR","P41_48HTR","P48_HTR","TOTVIVHAB",
										 "VIVPARHAB","OCUVIVPAR","PRO_OVP","PRO_OCVP","VP_PARDES","VP_TECDES","VP_PISDES","VP_CCUART",
										 "VP2_5CUAR","VP_2CUAR","V_1CUARTO","VP_COCGAS","VP_COCLEN","VP_COCCAR","VP_COCPET","VP_SERSAN",
										 "VP_AGUENT","VP_DRENAJ","VP_ELECTR","VP_DREAGU","VP_DREELE","VP_AGUELE","VP_AGDREL","VP_NOADE",
										 "VP_PROPIA","VP_PPAGAD","VP_PPAGAN","VP_RENTAD","VP_CBIENE","VP_SBIENE","VP_RADIO","VP_TV",
										 "VP_VIDEO","VP_REFRI","VP_LAVAD","VP_TELEF","VP_BOILER","VP_AUTOM","TOTHOG","HOGJEFM",
										 "HOGJEFF","POBHOG","PHOGJEFM","PHOGJEFF")

#'_________________________________________________________________________

#'set directory path for shapefiles
setwd(shapepath)


readOGR(".", "pobcloc10cw_50pop_1km_Pacifico_WGS84") %>% proj4string
#'read shapefile coastal locations >50 habitats
coastal.states <- readOGR(".", "pobcloc10cw_50pop_1km_Pacifico_WGS84") %>% 
	as("data.frame") %>% 
	tbl_df %>% 
	dplyr::select(one_of(coastal.coding)) %>% 
  .$CVE_EDO %>% 
  as.character %>% 
  as.numeric %>% 
  unique

coastal.pops <- readOGR(".", "pobcloc10cw_50pop_1km_Pacifico_WGS84") %>% 
  as("data.frame") %>% 
  tbl_df %>% 
  dplyr::select(one_of(coastal.coding)) %>%
  mutate_each(funs(as.character)) %>%
  mutate_each(funs(as.numeric)) %>% 
#unite(IDENTIFIER,ENTIDAD,MUN,LOC, sep = "_") %>% 
	unique(by=c("CVE_EDO","CVE_MUN","CVE_LOC")) %>%  #select variables for coding
setnames(c("ENTIDAD","MUN","LOC"))
         
coastal.pops.shape <- readOGR(".", "pobcloc10cw_50pop_1km_Pacifico_WGS84")  
  


coastal.pops.list <- coastal.pops.shape  %>% 
  as("data.frame") %>% 
  tbl_df %>% 
  dplyr::select(one_of(coastal.coding), NOM_LOC, NOM_ENT, NOM_MUN, lon_dd, lat_dd) %>%
  mutate_each_(funs(as.character),coastal.coding) %>% 
  mutate_each_(funs(as.numeric),coastal.coding) %>%
  unique(by=c("CVE_EDO","CVE_MUN","CVE_LOC")) %>% #select variables for coding
unite(IDENTIFIER,CVE_EDO,CVE_MUN,CVE_LOC, sep = "_") %>% 
  as.data.frame %>% 
  .$IDENTIFIER %>% 
  as.character
  
coastal.pops.shape$IDENTIFIER = coastal.pops.list
coastal.pops.shape@data
writeOGR(coastal.pops.shape, ".", "comunidades_pacifico",driver="ESRI Shapefile",overwrite_layer=TRUE)


#' for excel files from INEGI ITER statistics by state
setwd(datapath)

#find coastal states
inegi.2010.data = as.data.frame(matrix(0,nrow=0,ncol=80))
#'for debugging
#'each.folder = 1
for(each.folder in 1:length(foldersinegi))# for each folder
  {
  foldersinegi[each.folder] %>% #set working directory
  paste(datapath,"/",.,sep="") %>% setwd
  
  xls.files <- list.files(pattern = "\\.xls$")#' list xls files
  
  inegi.year = unlist(strsplit(foldersinegi[each.folder],"_"))[3] #find census year

  inegi.pop.data = as.data.frame(matrix(0,nrow=0,ncol=2))
  
  #'for debugging
  #'each.file = 1
#'loop to read in data and obtain GOC data
for(each.file in 1:length(xls.files))
{
 
	#'print progress
  print(paste("Analyzing"," file",xls.files[each.file]," ",each.file,":",length(xls.files))) 
  
	#'create population size variable name for each year
    inegi.names = c(inegi.coding,paste("POPTOT",inegi.year,sep="_"))
     
    #'read excel files and save as object 
    inegi.data <- xls.files[each.file] %>% 
        read_excel(sheet = 1, col_names = TRUE, col_types = NULL, na = "",skip = 0) 
      
      #'for inegi census 1990 and 2000 give new column names
      #'the original names have an extra tab that makes them unusable
      if(inegi.year==1990)
        { 
        inegi.data <- inegi.data %>% 
          setnames(inegi.1990.names) 
      }  
      
      if(inegi.year==2000)
        {
        inegi.data <- inegi.data %>% 
          setnames(inegi.2000.names)
      } 
        
      #'extract coding variables and total population
      #'rename
      #'check if state is a coastal state
    inegi.subset.data <- inegi.data %>% 
        dplyr::select(one_of(inegi.coding),matches("POPTOT"),matches("P_TOTAL"),matches("POBTOT")) %>% 
        mutate_each(funs(as.character)) %>% 
      mutate_each(funs(as.numeric)) %>% 
      unique(by=c("ENTIDAD","MUN","LOC")) %>% 
      	setnames(inegi.names) 
      
        #'mutate_each_(.,funs(factor), inegi.coding) %>% #'can be used to change multiple columns
      	
    match.state <- inegi.data %>%
      	.$ENTIDAD %>% 
        unique %>% 
      	  as.numeric %>% 
        is.element(coastal.states)
      
      #'if state is coastal then join with coastal population table
      #'then merge with results data frame
      if(match.state==TRUE)
      {
        state.data <- coastal.pops %>% 
          inner_join(inegi.subset.data,by=c("ENTIDAD","MUN","LOC"))
         
        inegi.pop.data = rbind(inegi.pop.data,state.data)
      
      	#'this section is only for 2010 data and will extract all
      	#'population composition variables
      	#'including population, education characteristics, and indigenous 
      	#'languages
      	if(inegi.year==2010)
      	{
      	inegi.2010.state.data <- inegi.data %>% 
      	  dplyr::select(-NOM_ENT, -NOM_MUN, -NOM_LOC, -LONGITUD, -LATITUD, -ALTITUD) %>%
      	mutate_each(funs(as.numeric)) %>%
      	  unique(by=c("ENTIDAD","MUN","LOC"))%>% 
      	  inner_join(coastal.pops,by=c("ENTIDAD","MUN","LOC")) %>% 
      			dplyr::select(ENTIDAD,MUN,LOC, starts_with("POB"), starts_with("P_"), starts_with("P3YM"), starts_with("P3YM"), starts_with("P3HLI"), starts_with("P5_HLI"), starts_with("PEA"), starts_with("PE_"), starts_with("POCUPADA"), starts_with("PDESOCUP"),contains("HOG"),contains("GRAPROES")) 
      			
      	
      	inegi.2010.data = rbind(inegi.2010.data,inegi.2010.state.data)
      	
      	} #close for 2010 data
            	} #close for coastal states
      	
      } # close for each file
  
  print(paste(nrow(coastal.pops), " coastal communities",sep=""))
  print(paste("INEGI data for",inegi.year," has",nrow(inegi.pop.data)," rows",sep=""))
  
  #'save one file per census year
  setwd(analysispath)
  write.csv(inegi.pop.data, file = paste("inegi_",inegi.year,"_pop.csv",sep=""), row.names = FALSE)
} #'close for each folder

 
#'now read in census files for each year and join all together
#'here we use left join
#'populations that don't have data in a census year
#'get an NA
#'

setwd(analysispath)

csv.files <- c("inegi_1990_pop.csv","inegi_2000_pop.csv","inegi_2005_pop.csv","inegi_2010_pop.csv")

for(each.file in 1:length(csv.files))
{
 
    this.name = unlist(strsplit(csv.files[each.file],"[.]"))[1]
    
    this.name.data <- tbl_df(fread(csv.files[each.file],header=TRUE))
    
    assign(this.name, this.name.data)
    
}

#' merge yearly census with complete file
       coastal.pop.data <- coastal.pops %>% 
         left_join(inegi_1990_pop,by=c("ENTIDAD","MUN","LOC")) %>% 
         left_join(inegi_2000_pop,by=c("ENTIDAD","MUN","LOC")) %>% 
       left_join(inegi_2005_pop,by=c("ENTIDAD","MUN","LOC")) %>% 
       left_join(inegi_2010_pop,by=c("ENTIDAD","MUN","LOC")) %>% 
  #' calculate population shange between multiple years
  mutate(POPCHANGE_90_10=(((POPTOT_2010-POPTOT_1990)/POPTOT_1990)*100)) %>% 
  mutate(POPCHANGE_90_00=(((POPTOT_2000-POPTOT_1990)/POPTOT_1990)*100)) %>%
  mutate(POPCHANGE_00_10=(((POPTOT_2010-POPTOT_2000)/POPTOT_2000)*100)) %>% 
  mutate(POPCHANGE_05_10=(((POPTOT_2010-POPTOT_2005)/POPTOT_2005)*100)) %>%
  dplyr::select(-POPTOT_1990, -POPTOT_2000, -POPTOT_2005, -POPTOT_2010) #eliminate total pop variables
 
    #Normalize 2010 data table using POBTOT, POBMAS and POBFEM
       male.pop <- inegi.2010.data %>%
         dplyr::select(ENTIDAD,MUN,LOC,POBMAS,ends_with("_M")) %>% 
         dplyr::select(-contains("HOG"),-contains("GRAPROES")) %>% 
         mutate_each(funs(. *100/ POBMAS), P_0A2_M:PDESOCUP_M) %>% 
         dplyr::select(-POBMAS)
       
       male.households <- inegi.2010.data %>%  
         dplyr::select(ENTIDAD,MUN,LOC,POBTOT,TOTHOG,POBHOG,ends_with("_M")) %>% 
         dplyr::select(ENTIDAD,MUN,LOC,POBTOT,TOTHOG,POBHOG,contains("HOG"),-contains("GRAPROES"))%>% 
         mutate_each(funs(. *100/ TOTHOG), HOGJEF_M) %>% 
         mutate_each(funs(. *100/ POBHOG), PHOGJEF_M) %>% 
         mutate_each(funs(. / POBTOT), TOTHOG) %>% 
       mutate_each(funs(. *100/ POBTOT),POBHOG) %>% 
         dplyr::select(-POBTOT)
       
       female.pop <- inegi.2010.data %>%
         dplyr::select(ENTIDAD,MUN,LOC,POBFEM,ends_with("_F")) %>% 
         dplyr::select(-contains("HOG"),-contains("GRAPROES")) %>% 
         mutate_each(funs(. *100/ POBFEM), P_0A2_F:PDESOCUP_F) %>% 
       dplyr::select(-POBFEM)
       
       female.households <- inegi.2010.data %>%  
         dplyr::select(ENTIDAD,MUN,LOC,POBTOT,TOTHOG,POBHOG,ends_with("_F")) %>% 
         dplyr::select(ENTIDAD,MUN,LOC,POBTOT,TOTHOG,POBHOG,contains("HOG"),-contains("GRAPROES"))%>% 
         mutate_each(funs(. *100/ TOTHOG), HOGJEF_F) %>% 
         mutate_each(funs(. *100/ POBHOG), PHOGJEF_F) %>% 
         dplyr::select(-POBTOT,-TOTHOG,-POBHOG)
         
       
       total.pop <- inegi.2010.data %>%
         dplyr::select(-ends_with("_F"), -ends_with("_M"), -contains("HOG"), -contains("GRAPROES")) %>% 
         mutate_each(funs(. *100/ POBTOT), POB0_14:PDESOCUP) %>% 
         dplyr::select(-POBTOT, -POBMAS, -POBFEM)
       
       education.pop <- inegi.2010.data %>% dplyr::select(ENTIDAD,MUN,LOC,contains("GRAPROES"))
       
       pop.comp.data <- coastal.pop.data %>% 
         left_join(total.pop,by=c("ENTIDAD","MUN","LOC")) %>%
         left_join(education.pop,by=c("ENTIDAD","MUN","LOC")) %>%
         left_join(female.households,by=c("ENTIDAD","MUN","LOC")) %>%
         left_join(male.households,by=c("ENTIDAD","MUN","LOC")) %>%
         left_join(female.pop,by=c("ENTIDAD","MUN","LOC")) %>%
         left_join(male.pop,by=c("ENTIDAD","MUN","LOC")) %>%
         dplyr::select(-HOGJEF_M)

inegi.identifier <- pop.comp.data %>% 
  unite(IDENTIFIER,ENTIDAD,MUN,LOC, sep = "_") %>% 
  as.data.frame %>% 
  .$IDENTIFIER

pop.comp.data <-  pop.comp.data %>%
  dplyr::select(-ENTIDAD, -MUN, -LOC) %>% 
  as.data.frame

rownames(pop.comp.data) <- inegi.identifier


write.csv(pop.comp.data, file = paste("variables",index.name,".csv",sep=""), row.names = TRUE)

