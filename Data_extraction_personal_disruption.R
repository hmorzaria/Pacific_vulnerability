#'Hem Nalini Morzaria Luna
#'hmorzarialuna@gmail.com
#'July 2015
#'Extract INEGI population composition variables
#'for coastal communities in the Pacific


#'call needed packages
#' install.packages(c("sp","gdata","maptools","PBSmapping","rgdal","fields","raster",
#' "rasterVis","dplyr","readxl","data.table","pipeR","tidyr","magrittr")) 
library(sp)
library(gdata)
library(maptools)
library(rgdal)
library(PBSmapping)
library(fields)
library(tidyr)
library(pipeR)
library(rasterVis)
library(readxl)
library(data.table)
library(magrittr)
library(dplyr)
library(raster)

####
#'clean up the space
rm(list=ls())

#'Initally extract total population from INEGI files
#'total population is needed from all 1990-2010
#'
#' USER BLOCK: CHECK AND CHANGE OPTIONS HERE  
#'_________________________________________________________________________
#'set working directories
#'this should match the path where your files directories are stored
#'note the "/" go in the opposite direction than in Windows explorer

#'All population composition variables are at the scale of locality
#'All data read in from INEGI files
#'
datapath="E:/Archivos/1Archivos/Articulos/En preparacion/Vulnerability_GOC_Pacific/Data" #'put path
analysispath="E:/Archivos/1Archivos/Articulos/En preparacion/Vulnerability_GOC_Pacific/Analysis" #'put path
shapepath = "E:/Archivos/SIG/Proyectos/ArcGis/Datos ordenados/Shapes y layers/Archivos_articulos/Vulnerabilidad_pacifico"
analysispath="E:/Archivos/1Archivos/Articulos/En preparacion/Vulnerability_GOC_Pacific/Analysis/ResultsINEGI" #'put path

#'folders storing xls files from each census
foldersinegi=c("INEGI_Censo_2010")

#'coding variables in INEGI files 
inegi.coding = c("ENTIDAD","MUN","LOC")
coastal.coding = c("CVE_EDO","CVE_MUN","CVE_LOC")

index.name = "LaborForce"

#'set directory path for shapefiles
setwd(shapepath)


readOGR(".", "pobcloc10cw_50pop_1km_Pacifico_WGS84") %>% proj4string
#'read shapefile coastal locations >50 habitats
coastal.states <- readOGR(".", "pobcloc10cw_50pop_1km_Pacifico_WGS84") %>% 
  as("data.frame") %>% 
  tbl_df %>% 
  dplyr::select(one_of(coastal.coding)) %>% 
  .$CVE_EDO %>% 
  as.character %>% 
  as.numeric %>% 
  unique

coastal.pops <- readOGR(".", "pobcloc10cw_50pop_1km_Pacifico_WGS84") %>% 
  as("data.frame") %>% 
  tbl_df %>% 
  dplyr::select(one_of(coastal.coding)) %>%
  mutate_each(funs(as.character)) %>%
  mutate_each(funs(as.numeric)) %>% 
  #unite(IDENTIFIER,ENTIDAD,MUN,LOC, sep = "_") %>% 
  unique(by=c("CVE_EDO","CVE_MUN","CVE_LOC")) %>%  #select variables for coding
  setnames(c("ENTIDAD","MUN","LOC"))
#' ################################################

#' for excel files from INEGI ITER statistics by state
setwd(datapath)

#find coastal states
inegi.2010.data = as.data.frame(matrix(0,nrow=0,ncol=80))
#'for debugging
#'each.folder = 1

each.folder = "INEGI_Censo_2010"

  each.folder %>% #set working directory
  paste(datapath,"/",.,sep="") %>% setwd
  
  xls.files <- list.files(pattern = "\\.xls$")#' list xls files
  
  inegi.year = unlist(strsplit(each.folder,"_"))[3] #find census year

   #'for debugging
  #'each.file = 3
#'loop to read in data and obtain GOC data
for(each.file in 1:length(xls.files))
{
 
	#'print progress
  print(paste("Analyzing"," file",xls.files[each.file]," ",each.file,":",length(xls.files))) 
  
	#'create population size variable name for each year
    inegi.names = c(inegi.coding,paste("POPTOT",inegi.year,sep="_"))
     
    #'read excel files and save as object 
    inegi.data <- xls.files[each.file] %>% 
        read_excel(sheet = 1, col_names = TRUE, col_types = NULL, na = "",skip = 0) 
      
        #'check if state is a coastal state
      	
    match.state <- inegi.data %>%
      	.$ENTIDAD %>% 
        unique %>% 
      	  as.numeric %>% 
        is.element(coastal.states)
      
      #'if state is coastal then join with coastal population table
      #'then merge with results data frame
      if(match.state==TRUE)
      {
   
      	inegi.2010.state.data <- inegi.data %>% 
      	  dplyr::select(-NOM_ENT, -NOM_MUN, -NOM_LOC, -LONGITUD, -LATITUD, -ALTITUD) %>%
      	mutate_each(funs(as.numeric)) %>%
      	  unique(by=c("ENTIDAD","MUN","LOC"))%>% 
      	  inner_join(coastal.pops,by=c("ENTIDAD","MUN","LOC")) %>% 
      			dplyr::select(ENTIDAD, MUN, LOC, POBTOT, POBMAS, POBFEM, ) %>% 
      	  	  mutate_each(funs(as.numeric)) 
      	
      	inegi.2010.data = rbind(inegi.2010.data,inegi.2010.state.data)
      	
      	} #close for match state
            
      	
      } # close for each file
  
  print(paste(nrow(coastal.pops), " coastal communities",sep=""))
  print(paste("INEGI data for ",inegi.year," has ",nrow(inegi.2010.data)," rows",sep=""))
  
  #'save one file per census year
  setwd(analysispath)
  write.csv(inegi.2010.data, file = paste("inegi_",inegi.year,"_poverty.csv",sep=""), row.names = FALSE)


 
#'now read in census files for each year and join all together
#'here we use left join
#'populations that don't have data in a census year
#'get an NA
#'

setwd(analysispath)


    #Normalize 2010 data table using POBTOT, POBMAS and POBFEM
       pop.comp <- inegi.2010.data %>%
         mutate_each(funs(. *100/ POBTOT), starts_with("PE"),-ends_with("M"),-ends_with("F"), POCUPADA, PDESOCUP,
                     PSINDER,starts_with("PDER")) %>% 
         mutate_each(funs(. *100/ POBMAS), matches("^PE.*M$"), POCUPADA_M, PDESOCUP_M) %>%
         mutate_each(funs(. *100/ POBFEM), matches("^PE.*F$"), POCUPADA_F, PDESOCUP_F) %>%
         mutate_each(funs(. *100/ POBTOT), POBFEM, POBMAS) %>% 
         dplyr::select(-POBTOT)
        

inegi.identifier <- pop.comp %>% 
  unite(IDENTIFIER,ENTIDAD,MUN,LOC, sep = "_") %>% 
  as.data.frame %>% 
  .$IDENTIFIER

pop.comp.data <-  pop.comp %>%
  dplyr::select(-ENTIDAD, -MUN, -LOC) %>% 
  as.data.frame

rownames(pop.comp.data) <- inegi.identifier


write.csv(pop.comp.data, file = paste("variables",this.index,".csv",sep-""), row.names = TRUE)

