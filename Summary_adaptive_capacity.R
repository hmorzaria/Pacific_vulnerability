# Hem Nalini Morzaria Luna
# Vulnerability indices
#based on Jacob et al. 2012 & Morzaria-Luna et al. 2014
#Created July 2015
#Last updated July 2015

#install.packages(c("data.table","gdata","tidyr","pipeR","erer","psych","nFactors","tidyr","pipeR","erer","reshape","ggplot2","dplyr","FactoMineR"))
library(nFactors)
library(reshape)
library(ggplot2)
library(dplyr)
library(gdata)
library(data.table)
library(tidyr)
library(pipeR)
library(erer)
library(FactoMineR)
library(magrittr)
library(maptools)


rm(list=ls()) #clean up the space

#list cutom functions
#source("E:/Archivos/1Archivos/Articulos/R_functions/pause_function.R")
source("E:/Archivos/1Archivos/Articulos/R_functions/Theta_function.R")

# USER BLOCK: CHECK AND CHANGE OPTIONS HERE  
#_________________________________________________________________________
#set working directories
#this should match the path where your files directories are stored
#note the "/" go in the opposite direction than in Windows explorer

#working space
analysispath="E:/Archivos/1Archivos/Articulos/En preparacion/Vulnerability_GOC_Pacific/Analysis/ResultsINEGI" #'put path
shapepath = "E:/Archivos/SIG/Proyectos/ArcGis/Datos ordenados/Shapes y layers/Archivos_articulos/Vulnerabilidad_pacifico"

setwd(shapepath)
comunidades <- readOGR(".", "comunidades_pacifico")  

crs.geo.wgs <- CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")

setwd(analysispath)

coastal.communities = 561 #if the number of communities changes based on assessment of fishing then change

#This section is to create a mean adaptive capacity score

comunidades.identifier <- comunidades  %>% 
  as("data.frame") %>% 
  tbl_df %>% 
  mutate_each_(funs(as.character),"IDENTIFIER") %>% 
  dplyr::select(IDENTIFIER) 


NormFunc <- function(x) (x-min.score)/(max.score-min.score)

pca.files <- list.files(pattern = "\\AC_pca_scores.csv$")

indices =c()

for(each.file in 1:length(pca.files)){
  
  this.file = pca.files[each.file] # read each file
  
  this.index = unlist(strsplit((this.file),"_"))[1] #get index name
  
    this.index.score <- pca.files[each.file] %>%  
    fread(header=T) %>% 
    tbl_df %>% 
    dplyr::select(names.locs,Dim.1) %>% 
      mutate_each_(funs(as.numeric),"Dim.1")%>%
    na.omit
    
    if(this.index == "PovertyIndex" || this.index == "LaborForce") {
      this.index.score <- this.index.score %>% 
    mutate_each(funs(.*-1),Dim.1)
  }

  max.score <- this.index.score %>%  
    dplyr::select (Dim.1) %>% max
    
  min.score <- this.index.score %>%  
    dplyr::select (Dim.1) %>% min
       
  
  adaptive.index <- this.index.score %>% 
    mutate(normalized = NormFunc(Dim.1)) %>%
    dplyr::select(names.locs, normalized)
    
  print(this.index)
  print(max(adaptive.index$normalized))
  print(min(adaptive.index$normalized))
  
  names(adaptive.index) = c("IDENTIFIER",this.index)
  
  
  comunidades.identifier <- comunidades.identifier  %>% 
      left_join(adaptive.index,by=c("IDENTIFIER")) 
  
  indices[each.file] = this.index
}
  
#create AdaptiveCapacity

comunidades.identifier <- comunidades.identifier %>% 
  dplyr::select(IDENTIFIER, PopulationComposition, PovertyIndex, LaborForce, HousingIndex) %>% 
  mutate(AdaptiveCapacity = PopulationComposition + PovertyIndex + LaborForce + HousingIndex)
  
  
#Normalize
max.score <- comunidades.identifier %>%  
  dplyr::select (AdaptiveCapacity) %>% 
  na.omit %>% 
  max

min.score <- comunidades.identifier %>%  
  dplyr::select (AdaptiveCapacity) %>% 
  na.omit %>% 
  min


comunidades.identifier <- comunidades.identifier %>% 
  mutate(normalizedAC = NormFunc(AdaptiveCapacity))

comunidades.identifier2 <- comunidades  %>% 
  as("data.frame") %>% 
  tbl_df %>% 
  mutate_each_(funs(as.character),"IDENTIFIER") %>% 
  dplyr::select(IDENTIFIER) 

comunidades.identifier <- comunidades.identifier2  %>% 
  left_join(comunidades.identifier,by=c("IDENTIFIER")) 

comunidades@data = data.frame(comunidades@data, comunidades.identifier[match(comunidades@data$IDENTIFIER, comunidades.identifier$IDENTIFIER),])


comunidades@data

  setwd(shapepath)
  writeOGR(comunidades, ".","Adaptive_capacity",driver="ESRI Shapefile",overwrite_layer=TRUE)
  
       
setwd(analysispath)

 write.csv(comunidades.identifier,"AdaptiveCapacity_vul_scores.csv")
 